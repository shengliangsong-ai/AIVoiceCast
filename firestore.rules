
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Master Owner account check
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'shengliang.song.ai@gmail.com' || 
        request.auth.token.email == 'shengliang.song@gmail.com'
      );
    }

    // ----------------------------------------------------------------------
    // Global Default: Deny everything unless explicitly allowed
    // ----------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if isAdmin(); // Admin always has full access
    }

    // ----------------------------------------------------------------------
    // USERS COLLECTION
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin(); 
    }

    // ----------------------------------------------------------------------
    // GROUPS & CHAT
    match /groups/{groupId} {
      allow read, write: if isAuthenticated();
      match /messages/{msgId} {
        allow read, write: if isAuthenticated();
      }
    }

    match /chat_channels/{channelId} {
      allow read, write: if isAuthenticated();
      match /messages/{msgId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ----------------------------------------------------------------------
    // PODCAST CHANNELS
    match /channels/{channelId} {
      allow read: if true; 
      allow create: if isAuthenticated();
      allow update: if isAdmin() || isOwner(resource.data.ownerId) || (
        isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments', 'appendix'])
      );
      allow delete: if isAdmin() || isOwner(resource.data.ownerId);
      
      match /lectures/{lectureId} { allow read, write: if true; }
    }

    // Separate Stats Table for Counters
    match /channel_stats/{channelId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ----------------------------------------------------------------------
    // DISCUSSIONS & DOCUMENTS
    match /discussions/{discussionId} {
      allow read: if resource.data.visibility == 'public' || isOwner(resource.data.userId) || isAdmin();
      allow write: if isAuthenticated();
    }

    // ----------------------------------------------------------------------
    // MOCK INTERVIEWS (FIX: ADDED FOR v4.3.0)
    match /mock_interviews/{interviewId} {
      allow read: if resource.data.visibility == 'public' || isOwner(resource.data.userId) || isAdmin();
      allow write: if isAuthenticated();
    }

    // ----------------------------------------------------------------------
    // SHARED ASSETS & UTILITY APPS
    match /invitations/{inviteId} { allow read, write: if isAuthenticated(); }
    match /bookings/{bookingId} { allow read, write: if isAuthenticated(); }
    match /recordings/{recordingId} { allow read, write: if isAuthenticated(); }
    match /saved_words/{wordId} { allow read, write: if isAuthenticated(); }
    
    // Utility App Collections
    // ALLOW PUBLIC READ for checks to enable shared link viewing
    match /checks/{checkId} { 
      allow read: if true;
      allow write: if isAuthenticated(); 
    }
    match /shipping/{labelId} { allow read, write: if isAuthenticated(); }
    match /icons/{iconId} { allow read, write: if isAuthenticated(); }
    match /cards/{cardId} { allow read, write: if isAuthenticated(); }
    match /coin_transactions/{txId} { allow read, write: if isAuthenticated(); }

    match /activity_logs/{logId} { allow create: if isAuthenticated(); allow read: if isAdmin(); }
  }
}
