rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'shengliang.song.ai@gmail.com' ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         'admin_neural_prism' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('groups', []))
      );
    }

    // ----------------------------------------------------------------------
    // Global Default
    // ----------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // ----------------------------------------------------------------------
    // SCRIPTURE LEDGERS
    // ----------------------------------------------------------------------
    match /bible_ledger/{chapterId} {
      allow read: if true; 
      allow create, update: if isAuthenticated(); 
      allow delete: if isAdmin();
    }

    match /bible_audio_ledger/{audioId} {
      allow read: if true; 
      allow create, update: if isAuthenticated(); 
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------
    // USERS & IDENTITY
    // ----------------------------------------------------------------------
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow create: if isOwner(userId);
      // MIDDLEMAN FIX: Users can ONLY update their own balance.
      // They never touch another user's balance directly.
      allow update: if isOwner(userId) || isAdmin(); 
    }

    // ----------------------------------------------------------------------
    // TRANSACTIONS & ESCROW
    // ----------------------------------------------------------------------
    match /invitations/{inviteId} { 
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow the recipient or sender to update status for the escrow flow
      allow update: if isAuthenticated(); 
    }
    
    match /receipts/{receiptId} { 
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated(); 
    }

    match /coin_transactions/{txId} { 
      allow read: if isAuthenticated(); 
      allow create: if isAuthenticated(); 
    }

    // ----------------------------------------------------------------------
    // REMAINING COLLECTIONS
    // ----------------------------------------------------------------------
    match /groups/{groupId} {
      allow read, write: if isAuthenticated();
      match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    }
    match /chat_channels/{channelId} {
      allow read, write: if isAuthenticated();
      match /messages/{msgId} { allow read, write: if isAuthenticated(); }
    }
    match /channels/{channelId} {
      allow read: if true; 
      allow create: if isAuthenticated();
      allow update: if isAdmin() || isOwner(resource.data.ownerId) || (
        isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['comments', 'appendix'])
      );
      allow delete: if isAdmin() || isOwner(resource.data.ownerId);
    }
    match /channel_stats/{channelId} { allow read: if true; allow write: if isAuthenticated(); }
    match /discussions/{discussionId} { allow read: if resource.data.visibility == 'public' || isOwner(resource.data.userId) || isAdmin(); allow write: if isAuthenticated(); }
    match /mock_interviews/{interviewId} { allow read: if resource.data.visibility == 'public' || isOwner(resource.data.userId) || isAdmin(); allow write: if isAuthenticated(); }
    match /bookings/{bookingId} { allow read, write: if isAuthenticated(); }
    match /recordings/{recordingId} { allow read, write: if isAuthenticated(); }
    match /saved_words/{wordId} { allow read, write: if isAuthenticated(); }
    match /checks/{checkId} { allow read: if true; allow write: if isAuthenticated(); }
    match /shipping/{labelId} { allow read, write: if isAuthenticated(); }
    match /icons/{iconId} { allow read, write: if isAuthenticated(); }
    match /cards/{cardId} { allow read, write: if isAuthenticated(); }
    match /tasks/{taskId} { allow read, write: if isAuthenticated(); }
    match /notebooks/{notebookId} { allow read, write: if isAuthenticated(); }
    match /feedback/{feedbackId} { allow read, write: if isAuthenticated(); }
  }
}